name: Discord Release Notification

on:
  release:
    types: [published]

jobs:
  notify-discord:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: pip install openai discord-webhook requests

      - name: Enhance release notes and send to Discord
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          OPENAI_BASE_URL: https://api.siliconflow.cn/v1
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          cat > send_discord_notification.py << 'EOF'
          import os
          import sys
          import json
          from openai import OpenAI
          import requests
          from datetime import datetime
          from discord_webhook import DiscordWebhook, DiscordEmbed

          # è®¾ç½®OpenAIå®¢æˆ·ç«¯
          client = OpenAI(
              api_key=os.environ.get("OPENAI_API_KEY"),
              base_url=os.environ.get("OPENAI_BASE_URL")
          )

          # è·å–GitHub releaseä¿¡æ¯
          github_token = os.environ.get("GITHUB_TOKEN")
          repo = os.environ.get("GITHUB_REPOSITORY")
          
          # ç›´æ¥ä»GitHub APIè·å–æœ€æ–°release
          headers = {"Authorization": f"token {github_token}"}
          response = requests.get(f"https://api.github.com/repos/{repo}/releases/latest", headers=headers)
          
          if response.status_code != 200:
              print(f"Error fetching release info: {response.status_code}")
              print(response.text)
              sys.exit(1)
              
          release_info = response.json()
          
          # æå–éœ€è¦çš„ä¿¡æ¯
          release_notes = release_info.get("body", "æ— å‘å¸ƒè¯´æ˜")
          version = release_info.get("tag_name", "æœªçŸ¥ç‰ˆæœ¬")
          
          # å®‰å…¨åœ°è§£æå‘å¸ƒæ—¥æœŸ
          published_at = release_info.get("published_at")
          if published_at:
              try:
                  release_date = datetime.strptime(published_at, "%Y-%m-%dT%H:%M:%SZ").strftime("%Yå¹´%mæœˆ%dæ—¥")
              except ValueError:
                  release_date = "æœªçŸ¥æ—¥æœŸ"
          else:
              release_date = "æœªçŸ¥æ—¥æœŸ"

          # ä½¿ç”¨å¤§æ¨¡å‹æ¶¦è‰²å‘å¸ƒè¯´æ˜
          try:
              response = client.chat.completions.create(
                  model="deepseek-ai/DeepSeek-V3",
                  messages=[
                      {"role": "system", "content": "ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„è½¯ä»¶å‘å¸ƒå…¬å‘Šä¼˜åŒ–åŠ©æ‰‹ã€‚è¯·ä¼˜åŒ–ä»¥ä¸‹å‘å¸ƒè¯´æ˜ï¼Œä½¿å…¶æ›´åŠ ç”ŸåŠ¨ã€ä¸“ä¸šï¼Œå¹¶æ˜ç¡®åŒºåˆ†æ–°åŠŸèƒ½ã€ä¼˜åŒ–å†…å®¹ã€ä¿®å¤å†…å®¹å’Œç§»é™¤å†…å®¹ç­‰ç±»åˆ«ã€‚ä¿æŒåŸæœ‰ä¿¡æ¯çš„å®Œæ•´æ€§ï¼ŒåŒæ—¶å¢å¼ºå¯è¯»æ€§å’Œä¸“ä¸šæ€§ã€‚ä½¿ç”¨ä¸­æ–‡å›å¤ã€‚"},
                      {"role": "user", "content": f"è¯·ä¼˜åŒ–ä»¥ä¸‹ç‰ˆæœ¬{version}çš„å‘å¸ƒè¯´æ˜ï¼Œä½¿å…¶æ›´é€‚åˆåœ¨Discordç¤¾åŒºå‘å¸ƒï¼š\n\n{release_notes}"}
                  ],
                  temperature=0.7,
              )
              enhanced_notes = response.choices[0].message.content
              print(f"å¤§æ¨¡å‹æ¶¦è‰²åçš„å‘å¸ƒè¯´æ˜: \n{enhanced_notes}")
          except Exception as e:
              print(f"Error calling OpenAI API: {e}")
              enhanced_notes = release_notes  # å¦‚æœAPIè°ƒç”¨å¤±è´¥ï¼Œä½¿ç”¨åŸå§‹å‘å¸ƒè¯´æ˜
          
          # åˆ›å»ºDiscordæ¶ˆæ¯
          webhook_url = os.environ.get("DISCORD_WEBHOOK_URL")
          if not webhook_url:
              print("Error: DISCORD_WEBHOOK_URL not set")
              sys.exit(1)
              
          webhook = DiscordWebhook(url=webhook_url)
          
          # åˆ›å»ºåµŒå…¥å¼æ¶ˆæ¯
          embed = DiscordEmbed(
              title=f"ğŸš€ NarratoAI {version} å‘å¸ƒå…¬å‘Š",
              description=f"å‘å¸ƒæ—¥æœŸ: {release_date}",
              color="5865F2"  # Discordè“è‰²
          )
          
          # æ·»åŠ æ¶¦è‰²åçš„å‘å¸ƒè¯´æ˜
          if enhanced_notes:
              embed.add_embed_field(name="æ›´æ–°å†…å®¹", value=enhanced_notes[:1024] if len(enhanced_notes) > 1024 else enhanced_notes)
              
              # å¦‚æœå†…å®¹å¤ªé•¿ï¼Œåˆ†æ®µæ·»åŠ 
              if len(enhanced_notes) > 1024:
                  remaining = enhanced_notes[1024:]
                  chunks = [remaining[i:i+1024] for i in range(0, len(remaining), 1024)]
                  for i, chunk in enumerate(chunks):
                      embed.add_embed_field(name=f"æ›´æ–°å†…å®¹ï¼ˆç»­{i+1}ï¼‰", value=chunk)
          else:
              embed.add_embed_field(name="æ›´æ–°å†…å®¹", value="æ— è¯¦ç»†æ›´æ–°å†…å®¹")
          
          # æ·»åŠ ä¸‹è½½é“¾æ¥
          html_url = release_info.get("html_url", "")
          if html_url:
              embed.add_embed_field(name="ä¸‹è½½é“¾æ¥", value=html_url)
          
          # è®¾ç½®é¡µè„š
          embed.set_footer(text="NarratoAI å›¢é˜Ÿ")
          embed.set_timestamp()
          
          # æ·»åŠ åµŒå…¥å¼æ¶ˆæ¯åˆ°webhook
          webhook.add_embed(embed)
          
          # å‘é€æ¶ˆæ¯
          response = webhook.execute()
          if response:
              print(f"Discord notification sent with status code: {response.status_code}")
          else:
              print("Failed to send Discord notification")
          EOF
          
          # æ‰§è¡Œè„šæœ¬
          python send_discord_notification.py 