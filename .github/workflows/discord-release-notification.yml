name: Discord Release Notification

on:
  release:
    types: [published]

jobs:
  notify-discord:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: pip install openai discord-webhook

      - name: Enhance release notes and send to Discord
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          OPENAI_BASE_URL: https://api.siliconflow.cn/v1
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          cat > send_discord_notification.py << 'EOF'
          import os
          import sys
          import json
          import openai
          from datetime import datetime
          from discord_webhook import DiscordWebhook, DiscordEmbed

          # è®¾ç½®OpenAI APIå‚æ•°
          openai.api_key = os.environ.get("OPENAI_API_KEY")
          openai.base_url = os.environ.get("OPENAI_BASE_URL")

          # èŽ·å–GitHub releaseä¿¡æ¯
          release_info = json.loads(os.environ.get("RELEASE_INFO"))
          release_notes = release_info["body"]
          version = release_info["tag_name"]
          release_date = datetime.strptime(release_info["published_at"], "%Y-%m-%dT%H:%M:%SZ").strftime("%Yå¹´%mæœˆ%dæ—¥")

          # ä½¿ç”¨å¤§æ¨¡åž‹æ¶¦è‰²å‘å¸ƒè¯´æ˜Ž
          response = openai.chat.completions.create(
              model="deepseek-ai/DeepSeek-V3",
              messages=[
                  {"role": "system", "content": "ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„è½¯ä»¶å‘å¸ƒå…¬å‘Šä¼˜åŒ–åŠ©æ‰‹ã€‚è¯·ä¼˜åŒ–ä»¥ä¸‹å‘å¸ƒè¯´æ˜Žï¼Œä½¿å…¶æ›´åŠ ç”ŸåŠ¨ã€ä¸“ä¸šï¼Œå¹¶æ˜Žç¡®åŒºåˆ†æ–°åŠŸèƒ½ã€ä¼˜åŒ–å†…å®¹ã€ä¿®å¤å†…å®¹å’Œç§»é™¤å†…å®¹ç­‰ç±»åˆ«ã€‚ä¿æŒåŽŸæœ‰ä¿¡æ¯çš„å®Œæ•´æ€§ï¼ŒåŒæ—¶å¢žå¼ºå¯è¯»æ€§å’Œä¸“ä¸šæ€§ã€‚ä½¿ç”¨ä¸­æ–‡å›žå¤ã€‚"},
                  {"role": "user", "content": f"è¯·ä¼˜åŒ–ä»¥ä¸‹ç‰ˆæœ¬{version}çš„å‘å¸ƒè¯´æ˜Žï¼Œä½¿å…¶æ›´é€‚åˆåœ¨Discordç¤¾åŒºå‘å¸ƒï¼š\n\n{release_notes}"}
              ],
              temperature=0.7,
          )
          
          enhanced_notes = response.choices[0].message.content
          
          # åˆ›å»ºDiscordæ¶ˆæ¯
          webhook = DiscordWebhook(url=os.environ.get("DISCORD_WEBHOOK_URL"))
          
          # åˆ›å»ºåµŒå…¥å¼æ¶ˆæ¯
          embed = DiscordEmbed(
              title=f"ðŸš€ NarratoAI {version} å‘å¸ƒå…¬å‘Š",
              description=f"å‘å¸ƒæ—¥æœŸ: {release_date}",
              color="5865F2"  # Discordè“è‰²
          )
          
          # æ·»åŠ æ¶¦è‰²åŽçš„å‘å¸ƒè¯´æ˜Ž
          embed.add_embed_field(name="æ›´æ–°å†…å®¹", value=enhanced_notes[:1024] if len(enhanced_notes) > 1024 else enhanced_notes)
          
          # å¦‚æžœå†…å®¹å¤ªé•¿ï¼Œåˆ†æ®µæ·»åŠ 
          if len(enhanced_notes) > 1024:
              remaining = enhanced_notes[1024:]
              chunks = [remaining[i:i+1024] for i in range(0, len(remaining), 1024)]
              for i, chunk in enumerate(chunks):
                  embed.add_embed_field(name=f"æ›´æ–°å†…å®¹ï¼ˆç»­{i+1}ï¼‰", value=chunk)
          
          # æ·»åŠ ä¸‹è½½é“¾æŽ¥
          embed.add_embed_field(name="ä¸‹è½½é“¾æŽ¥", value=release_info["html_url"])
          
          # è®¾ç½®é¡µè„š
          embed.set_footer(text="NarratoAI å›¢é˜Ÿ")
          embed.set_timestamp()
          
          # æ·»åŠ åµŒå…¥å¼æ¶ˆæ¯åˆ°webhook
          webhook.add_embed(embed)
          
          # å‘é€æ¶ˆæ¯
          response = webhook.execute()
          print(f"Discord notification sent with status code: {response.status_code}")
          EOF
          
          # èŽ·å–å‘å¸ƒä¿¡æ¯å¹¶ä¼ é€’ç»™è„šæœ¬
          echo "RELEASE_INFO='$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" https://api.github.com/repos/${{ github.repository }}/releases/latest)'" >> $GITHUB_ENV
          
          # æ‰§è¡Œè„šæœ¬
          python send_discord_notification.py 